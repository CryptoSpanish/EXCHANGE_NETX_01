<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NETX • Quantum Dashboard (Mejorado)</title>
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg0:#0c1220;--bg1:#131b2f;--panel:rgba(22,30,52,.85);
    --ink:#dfe7ff;--mut:#8ea0d3;--green:#2ad39b;--red:#ff5777;--cyan:#00e0ff;
    --border-color:#1b2440;--hover-bg:#0e1632;
    --ring-bg: rgba(255,255,255,.06);
  }
  html,body{height:100%}

  /* Fondo existente con animación suave */
  @keyframes futuristic-background {
    0% { background-position: 90% -10%, -20% 0%; }
    50% { background-position: -10% 110%, 120% 100%; }
    100% { background-position: 90% -10%, -20% 0%; }
  }
  body{
    margin:0;color:var(--ink);
    background-color: var(--bg1);
    background-image:
      radial-gradient(1200px 600px, rgba(94,208,255,.10), transparent 60%),
      radial-gradient(1000px 500px, rgba(42,211,155,.08), transparent 60%),
      linear-gradient(180deg,var(--bg0),var(--bg1));
    background-repeat:no-repeat;background-size:auto,auto,100% 100%;
    font-family:Oxanium,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    animation: futuristic-background 25s ease-in-out infinite;
  }

  /* === CAPA DE EFECTOS DE FONDO === */
  /* Canvas de partículas/líneas */
  #bgfx{
    position:fixed; inset:0; z-index:0; pointer-events:none; display:block;
  }
  /* Grid ciber con ligero desplazamiento */
  @keyframes grid-drift {
    0%{ background-position: 0 0, 0 0;}
    100%{ background-position: 200px 120px, 200px 120px;}
  }
  .bg-grid{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background-image:
      linear-gradient(transparent calc(100% - 1px), rgba(0,224,255,.10) 1px),
      linear-gradient(90deg, transparent calc(100% - 1px), rgba(0,224,255,.10) 1px);
    background-size:120px 120px, 120px 120px;
    opacity:.08;
    animation: grid-drift 30s linear infinite;
  }
  /* Scanlines muy sutiles */
  .bg-scan{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background: repeating-linear-gradient(
      180deg, rgba(0,0,0,.0) 0, rgba(0,0,0,.0) 3px, rgba(0,0,0,.03) 4px
    );
    mix-blend-mode: soft-light;
  }
  /* Respeto a usuarios con reduce motion */
  @media (prefers-reduced-motion: reduce) {
    body{animation:none}
    .bg-grid{animation:none}
  }

  /* === LAYOUT / TARJETAS === */
  .wrap{position:relative; z-index:1; max-width:1250px;margin:22px auto;padding:0 14px}
  .card{
    background:var(--panel);border:1px solid var(--border-color);border-radius:14px;padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.03);
    backdrop-filter:saturate(120%) blur(6px)
  }
  .title{display:flex;gap:10px;align-items:center;margin:0 0 12px}
  .title .dot{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,#1f2a4a,#304170)}
  .title h1{font-size:26px;margin:0}
  .pill{border:1px solid #2b3a66;color:#9fb3ff;background:rgba(30,45,86,.6);padding:6px 10px;border-radius:999px;font-size:12px;user-select:none}
  .row{display:grid;gap:16px}
  .row.kpis{grid-template-columns:repeat(6,1fr)}
  .kpi h3{margin:0 0 6px;color:#9fb3ff;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .kpi .v{font-size:28px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .v.green{color:var(--green)}.v.red{color:var(--red)}.v.cyan{color:var(--cyan)}
  .grid-2{display:grid;grid-template-columns:2.1fr 1fr;gap:16px}
  canvas{background:#0c1326;border-radius:12px;border:1px solid #1a2444}
  table{width:100%;border-collapse:collapse;color:#cfe3ff;font-size:13px}
  thead th{position:sticky;top:0;background:#0f1730;border-bottom:1px solid #2a3a66;padding:10px 8px;text-align:left;cursor:pointer;user-select:none;transition:background-color .2s}
  thead th:hover{background-color:var(--hover-bg)}
  thead th[data-order]::after{content:'';display:inline-block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;margin-left:8px;vertical-align:middle;opacity:.7}
  thead th[data-order="asc"]::after{border-bottom:5px solid var(--cyan)}
  thead th[data-order="desc"]::after{border-top:5px solid var(--cyan)}
  tbody td{border-bottom:1px solid #172045;padding:8px 8px}
  tbody tr:hover{background:var(--hover-bg)}
  .loading{animation:pulse 1.5s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .note{color:#9fb3ff;font-size:12px;margin-top:8px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  input#txtFilterAll{background:var(--bg0);border:1px solid #2b3a66;border-radius:8px;padding:8px 12px;color:var(--ink);font-family:inherit;font-size:14px;transition:border-color .2s}
  input#txtFilterAll:focus{outline:none;border-color:var(--cyan)}
  .btn{background:rgba(0,224,255,0.1);border:1px solid var(--cyan);color:var(--cyan);padding:6px 12px;border-radius:8px;cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s ease}
  .btn:hover{background:rgba(0,224,255,0.2);box-shadow:0 0 10px rgba(0,224,255,0.3)}
  .text-green { color: var(--green); font-weight: 600; }
  .text-red { color: var(--red); font-weight: 600; }
  .text-cyan { color: var(--cyan); font-weight: 600; }
  .table-container {border: 1px solid #172045;border-radius: 12px;overflow-x: auto}
  .pagination-controls {justify-content: center;margin-top: 16px;user-select: none}
  .pagination-controls .btn[disabled] {opacity: 0.5;cursor: not-allowed;background: transparent}
  .pagination-info {padding: 0 15px;align-self: center}

  /* === KPI “GAUGES” (fila nueva) === */
  .row.pki{grid-template-columns:repeat(6,1fr)}
  .kpi-mini h4{margin:0 0 4px;color:#9fb3ff;font-size:12px;letter-spacing:.3px;text-transform:uppercase}
  .kpi-mini .kpi-row{display:flex;align-items:center;gap:12px}
  .ring{
    --p: 0;         /* 0..100 */
    --clr: var(--cyan);
    width:58px;height:58px;border-radius:50%;
    background:
      conic-gradient(var(--clr) calc(var(--p)*1%), var(--ring-bg) 0);
    position:relative;flex:0 0 58px;
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 56%, #000 57%);
            mask: radial-gradient(circle at 50% 50%, transparent 56%, #000 57%);
    box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset, 0 0 20px rgba(0,224,255,.10);
  }
  .ring::after{
    content:''; position:absolute; inset:8px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.15), transparent 40%);
    box-shadow: inset 0 0 12px rgba(0,0,0,.45);
  }
  .kpi-pct{font-size:18px;font-weight:700;line-height:1}
  .kpi-sub{font-size:12px;color:#8ea0d3}
  .tag{display:inline-block;border:1px solid #2b3a66;color:#9fb3ff;background:rgba(30,45,86,.5);padding:2px 8px;border-radius:999px;font-size:11px}

  /* Banner inferior */
  .promo-banner {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(12, 18, 32, 0.85);
    border-top: 1px solid var(--cyan); box-shadow: 0 0 20px rgba(0, 224, 255, 0.2);
    backdrop-filter: blur(5px); padding: 12px 0; overflow: hidden; z-index: 1000;
  }
  .promo-banner a { display:block;width:100%;text-decoration:none;color:var(--ink);white-space:nowrap}
  .promo-banner .promo-text {
    display:inline-block;font-size:16px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;
    animation: scroll-left 30s linear infinite; will-change: transform;
  }
  @keyframes scroll-left { from{transform:translateX(100vw)} to{transform:translateX(-100%)} }

  @media (max-width:1100px){
    .row.kpis{grid-template-columns:repeat(3,1fr)}
    .row.pki{grid-template-columns:repeat(3,1fr)}
    .grid-2{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .row.kpis{grid-template-columns:repeat(2,1fr)}
    .row.pki{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>

<!-- Capas de fondo dinámico -->
<canvas id="bgfx" aria-hidden="true"></canvas>
<div class="bg-grid" aria-hidden="true"></div>
<div class="bg-scan" aria-hidden="true"></div>

<div class="wrap">
  <div class="card" aria-live="polite">
    <div class="title">
      <div class="dot"></div>
      <h1>NETX Dashboard</h1>
      <span id="badge" class="pill loading" title="Estado de carga">Cargando…</span>
    </div>
    <div id="msg" class="note" role="status"></div>
  </div>

  <!-- KPIs principales -->
  <div class="row kpis" aria-label="Indicadores clave">
    <div class="card kpi"><h3>PRECIO PROMEDIO $NETX</h3><div id="kpiPrecio" class="v">—</div></div>
    <div class="card kpi"><h3>TRADES TOTALES</h3><div id="kpiTrades" class="v">—</div></div>
    <div class="card kpi"><h3>$NETX COMPRADOS</h3><div id="kpiComprados" class="v green">—</div></div>
    <div class="card kpi"><h3>$NETX VENDIDOS</h3><div id="kpiVendidos" class="v red">—</div></div>
    <div class="card kpi"><h3>VOL. $NETX (total)</h3><div id="kpiVolNetx" class="v cyan">—</div></div>
    <div class="card kpi"><h3>VOL. USDT (total)</h3><div id="kpiVolUsdt" class="v">—</div></div>
  </div>

  <!-- KPI “gauges” estilo dashboard -->
  <div class="row pki" aria-label="Marcadores KPI">
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringMomentum" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Momentum precio</h4>
          <div id="kpiMomentum" class="kpi-pct">—</div>
          <div class="kpi-sub">vs. día anterior</div>
        </div>
      </div>
    </div>
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringDominio" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Dominio compras</h4>
          <div id="kpiDominio" class="kpi-pct">—</div>
          <div class="kpi-sub">Comprados / Total</div>
        </div>
      </div>
    </div>
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringTrades" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Intensidad trades</h4>
          <div id="kpiTradesDay" class="kpi-pct">—</div>
          <div class="kpi-sub">Día vs. máximo</div>
        </div>
      </div>
    </div>
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringVolNetx" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Vol. $NETX</h4>
          <div id="kpiVolNetxDay" class="kpi-pct">—</div>
          <div class="kpi-sub">Día vs. máximo</div>
        </div>
      </div>
    </div>
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringVolUsdt" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Vol. USDT</h4>
          <div id="kpiVolUsdtDay" class="kpi-pct">—</div>
          <div class="kpi-sub">Día vs. máximo</div>
        </div>
      </div>
    </div>
    <div class="card kpi-mini">
      <div class="kpi-row">
        <div id="ringGapEMA" class="ring" aria-hidden="true"></div>
        <div>
          <h4>Gap vs. MA7</h4>
          <div id="kpiGapEMA" class="kpi-pct">—</div>
          <div class="kpi-sub">Precio vs. media 7d</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfica y resumen por exchange -->
  <div class="grid-2">
    <div class="card">
      <div class="title"><div class="dot"></div><h1 style="font-size:18px">Serie temporal</h1></div>
      <canvas id="chart" aria-label="Serie temporal de precio y volumen" role="img"></canvas>
    </div>
    <div class="card">
      <div class="title"><div class="dot"></div><h1 style="font-size:18px">Resumen por Exchange (Totales)</h1></div>
      <table id="tblEx">
        <thead><tr><th>Exchange</th><th>Trades</th><th>Vendidos</th><th>Comprados</th><th>Vol. $NETX</th><th>Vol. USDT</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Histórico -->
  <div class="card" style="margin-top:16px">
    <div class="flex title">
      <div class="dot"></div><h1 style="font-size:18px">Histórico (resúmenes diarios)</h1>
      <span class="tag" id="dataInfo" aria-hidden="true">—</span>
      <div class="spacer"></div>
      <button id="btnRefresh" class="btn" title="Refrescar datos">Refrescar</button>
      <input id="txtFilterAll" placeholder="Filtrar…" style="max-width:220px" aria-label="Filtrar tabla histórica"/>
    </div>
    <div class="table-container">
      <table id="tblAll" aria-label="Tabla histórica"><thead></thead><tbody></tbody></table>
    </div>
    <div id="paginationControls" class="flex pagination-controls"></div>
  </div>
</div>

<script>
  // --- CONFIGURACIÓN Y CONSTANTES ---
  const TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGjCTThPQ3rbhgN9WDwDvmDSwCpq-ue9AZTFZNF4AJa7dvmtds1D46tgAr3727jSGJcxgNCOVACFjk/pub?output=tsv";
  const DISPLAY_NAME = { mexc:'MEXC', gate:'Gate.io', binance:'Binance', okx:'OKX', bybit:'Bybit' };
  const SYNONYMS = {
    precio:['precio','price','px'],
    trades_total:['trades_total','trades','tx_total'],
    comprados_total:['comprados_total','bought_total','buy_total'],
    vendidos_total:['vendidos_total','sold_total','sell_total'],
    vol_netx_total:['vol_netx_total','volume_netx_total','vol_total'],
    vol_usdt_total:['vol_usdt_total','volume_usdt_total'],
    fecha_ref:['fecha_ref','fecha','date','day']
  };

  // --- VARIABLES DE ESTADO GLOBAL ---
  let DATA = null;
  let CHART = null;
  let EXCHANGES = [];
  let HIST_FILTERED_DATA = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  // --- UTILIDADES ---
  const fmt = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 });
  const fmt2 = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const pct = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 1 });
  const $ = id => document.getElementById(id);
  const toNum = (x) => {
    if (x == null || x === '') return null;
    const s = x.toString().trim().replace(/\./g, '').replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  };

  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    if (isNaN(date.getTime())) return dateStr;
    const shortMonth = date.toLocaleDateString('es-ES', { month: 'short' });
    return `${date.getDate()} ${shortMonth.charAt(0).toUpperCase() + shortMonth.slice(1).replace('.','')}`;
  };

  const formatHeaderTitle = (header) => {
    if (!header) return '';
    return header
      .replace(/_/g, ' ')
      .replace(/\b\w/g, l => l.toUpperCase())
      .replace(/Usdt/g, 'USDT')
      .replace(/Netx/g, 'NETX');
  };

  // --- LÓGICA PRINCIPAL ---
  async function loadTSV(url) {
    setStatus('Cargando…', true);
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
      const tsv = await res.text();
      const parsed = parseTSV(tsv);
      if (!parsed || !parsed.data.length) throw new Error("No se encontraron datos válidos.");

      DATA = parsed;
      HIST_FILTERED_DATA = [...DATA.data];
      EXCHANGES = detectExchanges(DATA.headers);

      const info = `Registros: ${DATA.data.length} · Exchanges: ${EXCHANGES.length}`;
      $('dataInfo').textContent = info;
      setStatus(`✓ ${info}`, false, `Actualizado: ${new Date().toLocaleTimeString()}`);
      renderAll();
    } catch (err) {
      console.error(err);
      setStatus('Error de carga', false, err.message);
    }
  }

  function parseTSV(tsv) {
    const lines = tsv.replace(/\r\n?/g, '\n').trim().split('\n');
    if (lines.length < 2) return null;
    const headers = lines[0].split('\t').map(h => h.trim());
    const data = lines.slice(1).map(line => {
      if (!line.trim()) return null;
      const values = line.split('\t');
      const row = {};
      headers.forEach((h, idx) => row[h] = values[idx] ?? '');
      return row;
    }).filter(Boolean);
    return { headers, data };
  }

  function detectExchanges(headers) {
    const set = new Set();
    headers.forEach(h => {
      const m = h.match(/^(.*)_(trades|vendidos|comprados|vol_netx|vol_usdt)$/i);
      if (m && !m[1].toLowerCase().includes('total')) set.add(m[1].toLowerCase());
    });
    return Array.from(set).sort();
  }

  function resolveHeader(headers, key) {
    const list = SYNONYMS[key] || [key];
    return list.map(name => headers.find(h => h.toLowerCase() === name.toLowerCase())).find(Boolean) || null;
  }

  // --- RENDERIZADO GLOBAL ---
  function renderAll() {
    if (!DATA || !DATA.data.length) return;
    renderKPIs();
    renderExchangeTable();
    renderTimeSeriesChart();
    renderHistoryTable();
    renderKPIBadges();   // NUEVO: marcadores KPI
  }

  function renderKPIs() {
    const { headers, data } = DATA;
    const H_px = resolveHeader(headers, 'precio');
    const H_tt = resolveHeader(headers, 'trades_total');
    const H_bt = resolveHeader(headers, 'comprados_total');
    const H_st = resolveHeader(headers, 'vendidos_total');
    const H_vnt = resolveHeader(headers, 'vol_netx_total');
    const H_vut = resolveHeader(headers, 'vol_usdt_total');

    const sum = (H) => H ? data.reduce((acc, row) => acc + (toNum(row[H]) || 0), 0) : null;

    const avg = (H) => {
      if (!H) return null;
      let total = 0, count = 0;
      data.forEach(row => {
        const n = toNum(row[H]);
        if (n != null) { total += n; count++; }
      });
      return count > 0 ? total / count : null;
    };

    const priceAvg = avg(H_px);
    const volNetxSum = sum(H_vnt);
    const volUsdtSum = sum(H_vut);

    $('kpiPrecio').textContent = priceAvg != null ? '$' + fmt2.format(priceAvg) : '—';
    $('kpiTrades').textContent = fmt.format(sum(H_tt));
    $('kpiComprados').textContent = fmt.format(sum(H_bt));
    $('kpiVendidos').textContent = fmt.format(sum(H_st));
    $('kpiVolNetx').textContent = volNetxSum != null ? fmt.format(volNetxSum) : '—';
    $('kpiVolUsdt').innerHTML = volUsdtSum != null ? `${fmt.format(volUsdtSum)}&nbsp;$` : '—';
  }

  function renderExchangeTable() {
    const { headers, data } = DATA;
    const tbody = $('tblEx').querySelector('tbody');
    tbody.innerHTML = EXCHANGES.map(pfx => {
      const nm = DISPLAY_NAME[pfx] || pfx.toUpperCase();
      const sumBySuffix = (suffix) => {
        const header = `${pfx}_${suffix}`;
        if (!headers.includes(header)) return 0;
        return data.reduce((acc, row) => acc + (toNum(row[header]) || 0), 0);
      };
      return `<tr>
        <td>${nm}</td>
        <td>${fmt.format(sumBySuffix('trades'))}</td>
        <td class="text-red">${fmt.format(sumBySuffix('vendidos'))}</td>
        <td class="text-green">${fmt.format(sumBySuffix('comprados'))}</td>
        <td>${fmt.format(sumBySuffix('vol_netx'))}</td>
        <td>${fmt.format(sumBySuffix('vol_usdt'))}&nbsp;$</td>
      </tr>`;
    }).join('');
    enableSort('tblEx');
  }

  function renderTimeSeriesChart() {
    const { headers, data } = DATA;
    const H_px = resolveHeader(headers, 'precio');
    const H_vnt = resolveHeader(headers, 'vol_netx_total');
    const H_date = resolveHeader(headers, 'fecha_ref');

    const priceData = data.map(r => toNum(r[H_px]));
    const volData = data.map(r => toNum(r[H_vnt]));
    const labels = data.map(r => r[H_date] || '');

    if (CHART) CHART.destroy();
    CHART = new Chart($('chart').getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Precio $NETX', data: priceData, yAxisID: 'y', borderColor: '#00e0ff', backgroundColor: 'rgba(0,224,255,0.1)', tension: 0.25, borderWidth: 2, pointRadius: 0 },
          { label: 'Vol. $NETX (total)', data: volData, yAxisID: 'y1', type: 'bar', backgroundColor: 'rgba(42,211,155,0.6)', borderColor: '#2ad39b', borderWidth: 0 }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { position: 'left', grid: { color: '#1b2a4a' }, ticks: { color: '#9fb3ff' } },
          y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#9fb3ff' } },
          x: { grid: { color: '#1b2a4a' }, ticks: { color: '#9fb3ff' } }
        },
        plugins: {
          legend: { labels: { color: '#cfe3ff' } },
          tooltip: {
            backgroundColor: 'rgba(13,27,48,0.9)', titleColor: '#cfe3ff', bodyColor: '#9fb3ff',
            borderColor: '#2b3a66', borderWidth: 1,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) { label += ': '; }
                if (context.parsed.y !== null) {
                  const isPrice = context.dataset.yAxisID === 'y';
                  label += isPrice ? '$' + fmt2.format(context.parsed.y) : fmt.format(context.parsed.y);
                }
                return label;
              }
            }
          }
        }
      }
    });
  }

  function renderHistoryTable() {
    const { headers } = DATA;
    const tHead = $('tblAll').querySelector('thead');
    const tBody = $('tblAll').querySelector('tbody');
    const H_date = resolveHeader(headers, 'fecha_ref');

    if (!tHead.innerHTML) {
      tHead.innerHTML = `<tr>${headers.map((h, i) => {
        const title = (H_date && h === H_date) ? 'FECHA' : formatHeaderTitle(h);
        return `<th data-index="${i}">${title}</th>`
      }).join('')}</tr>`;
    }

    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const pageData = HIST_FILTERED_DATA.slice(startIndex, endIndex);

    tBody.innerHTML = pageData.map(row => {
      const cells = headers.map(h => {
        const lowerH = h.toLowerCase();
        const value = row[h];
        let formattedValue = value == null ? '' : value;
        let className = '';
        if (H_date && h === H_date) {
          formattedValue = formatDate(value);
        } else {
          const numValue = toNum(value);
          if (numValue != null) {
            if (lowerH.includes('precio')) {
              formattedValue = '$' + fmt2.format(numValue);
            } else if (lowerH.includes('usdt')) {
              formattedValue = `${fmt.format(numValue)}&nbsp;$`;
              className = 'class="text-cyan"';
            } else {
              formattedValue = fmt.format(numValue);
            }
          }
        }
        if (lowerH.includes('comprados')) className = 'class="text-green"';
        else if (lowerH.includes('vendidos')) className = 'class="text-red"';
        return `<td ${className}>${formattedValue}</td>`;
      });
      return `<tr>${cells.join('')}</tr>`;
    }).join('');

    renderPaginationControls();
  }

  function renderPaginationControls() {
    const totalRows = HIST_FILTERED_DATA.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const controlsContainer = $('paginationControls');
    if (totalPages <= 1) { controlsContainer.innerHTML = ''; return; }

    controlsContainer.innerHTML = `
      <button id="prevPage" class="btn" title="Página anterior">&laquo; Anterior</button>
      <span class="pagination-info pill">Página ${currentPage} de ${totalPages}</span>
      <button id="nextPage" class="btn" title="Página siguiente">Siguiente &raquo;</button>
    `;
    const prevButton = $('prevPage');
    const nextButton = $('nextPage');
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages;
    prevButton.onclick = () => { if (currentPage > 1) { currentPage--; renderHistoryTable(); } };
    nextButton.onclick = () => { if (currentPage < totalPages) { currentPage++; renderHistoryTable(); } };
  }

  // --- ORDENACIÓN, FILTRO, ESTADO ---
  function enableSort(tableId, isBig = false) {
    const table = $(tableId);
    const ths = table.querySelectorAll('thead th');
    ths.forEach((th, colIndex) => {
      th.onclick = () => {
        const currentOrder = th.getAttribute('data-order') || 'desc';
        const nextOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        ths.forEach(x => x.removeAttribute('data-order'));
        th.setAttribute('data-order', nextOrder);
        const idx = isBig ? parseInt(th.getAttribute('data-index'), 10) : colIndex;

        if (tableId === 'tblAll') {
          const headerName = DATA.headers[idx];
          if (!headerName) return;
          HIST_FILTERED_DATA.sort((a, b) => {
            const ta = a[headerName] || ''; const tb = b[headerName] || '';
            const na = toNum(ta), nb = toNum(tb);
            const cmp = (na != null && nb != null)
              ? na - nb
              : ta.toString().localeCompare(tb.toString(), 'es', { numeric: true, sensitivity: 'base' });
            return nextOrder === 'asc' ? cmp : -cmp;
          });
          currentPage = 1;
          renderHistoryTable();
        } else {
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.sort((a,b)=>{
            const ta=a.children[idx]?.textContent?.trim()||''; const tb=b.children[idx]?.textContent?.trim()||'';
            const na=toNum(ta), nb=toNum(tb);
            const cmp = (na!=null && nb!=null) ? na-nb : ta.localeCompare(tb,'es',{numeric:true,sensitivity:'base'});
            return nextOrder==='asc'?cmp:-cmp;
          });
          rows.forEach(r=>tbody.appendChild(r));
        }
      };
    });
  }

  function applyFilter() {
    const query = $('txtFilterAll').value.toLowerCase();
    HIST_FILTERED_DATA = DATA.data.filter(row =>
      Object.values(row).some(val => (val ?? '').toString().toLowerCase().includes(query))
    );
    currentPage = 1;
    renderHistoryTable();
  }

  function setStatus(text, loading = false, detail = '') {
    $('badge').textContent = text;
    $('badge').classList.toggle('loading', !!loading);
    $('badge').title = detail || '';
    $('msg').textContent = detail || '';
  }

  // --- KPI BADGES (NUEVO) ---
  function renderKPIBadges(){
    const { headers, data } = DATA;
    if (!data.length) return;

    const H_px = resolveHeader(headers, 'precio');
    const H_tt = resolveHeader(headers, 'trades_total');
    const H_bt = resolveHeader(headers, 'comprados_total');
    const H_st = resolveHeader(headers, 'vendidos_total');
    const H_vnt = resolveHeader(headers, 'vol_netx_total');
    const H_vut = resolveHeader(headers, 'vol_usdt_total');

    const last = data[data.length-1];
    const prev = data.length>1 ? data[data.length-2] : null;

    const lastPrice = toNum(last?.[H_px]);
    const prevPrice = toNum(prev?.[H_px]);
    const tradesMax = Math.max(...data.map(r => toNum(r[H_tt])||0), 1);
    const volNetxMax = Math.max(...data.map(r => toNum(r[H_vnt])||0), 1);
    const volUsdtMax = Math.max(...data.map(r => toNum(r[H_vut])||0), 1);

    const lastTrades = toNum(last?.[H_tt]) || 0;
    const lastVolNetx = toNum(last?.[H_vnt]) || 0;
    const lastVolUsdt = toNum(last?.[H_vut]) || 0;

    const lastComprados = toNum(last?.[H_bt]) || 0;
    const lastVendidos = toNum(last?.[H_st]) || 0;

    // Momentum precio (% vs día anterior)
    let mom = null;
    if (lastPrice!=null && prevPrice!=null && prevPrice!==0) {
      mom = ((lastPrice - prevPrice) / Math.abs(prevPrice)) * 100;
    }

    // Dominio de compras
    const dominio = (lastComprados + lastVendidos) > 0
      ? (lastComprados / (lastComprados + lastVendidos)) * 100
      : null;

    // Gap vs MA7
    const ma7 = movingAvg(data.map(r=>toNum(r[H_px])), 7);
    let gap = null;
    if (lastPrice!=null && ma7.length) {
      const lastMA7 = ma7[ma7.length-1];
      if (lastMA7 && lastMA7!==0) gap = ((lastPrice - lastMA7) / Math.abs(lastMA7)) * 100;
    }

    // Normalizaciones 0..100
    const tradesPct = (lastTrades / tradesMax) * 100;
    const vNetxPct = (lastVolNetx / volNetxMax) * 100;
    const vUsdtPct = (lastVolUsdt / volUsdtMax) * 100;

    // Escritura visual
    writeRing('ringMomentum', clampPct(Math.abs(mom ?? 0)), mom >= 0 ? 'var(--green)' : 'var(--red)');
    writeText('kpiMomentum', mom==null ? '—' : (mom>0?'+':'') + pct.format(mom) + ' %');

    writeRing('ringDominio', clampPct(dominio ?? 0), (dominio ?? 0) >= 50 ? 'var(--green)' : 'var(--red)');
    writeText('kpiDominio', dominio==null ? '—' : pct.format(dominio) + ' %');

    writeRing('ringTrades', clampPct(tradesPct), tradesPct>=66?'var(--green)':(tradesPct>=33?'var(--cyan)':'var(--red)'));
    writeText('kpiTradesDay', isFinite(tradesPct)? pct.format(tradesPct)+' %':'—');

    writeRing('ringVolNetx', clampPct(vNetxPct), vNetxPct>=66?'var(--green)':(vNetxPct>=33?'var(--cyan)':'var(--red)'));
    writeText('kpiVolNetxDay', isFinite(vNetxPct)? pct.format(vNetxPct)+' %':'—');

    writeRing('ringVolUsdt', clampPct(vUsdtPct), vUsdtPct>=66?'var(--green)':(vUsdtPct>=33?'var(--cyan)':'var(--red)'));
    writeText('kpiVolUsdtDay', isFinite(vUsdtPct)? pct.format(vUsdtPct)+' %':'—');

    const gapColor = (gap ?? 0) >= 0 ? 'var(--cyan)' : 'var(--red)';
    writeRing('ringGapEMA', clampPct(Math.abs(gap ?? 0)), gapColor);
    writeText('kpiGapEMA', gap==null ? '—' : (gap>0?'+':'') + pct.format(gap) + ' %');

    // Etiquetas accesibles
    $('#ringMomentum').setAttribute('aria-label', `Momentum del precio: ${$('kpiMomentum').textContent}`);
    $('#ringDominio').setAttribute('aria-label', `Dominio de compras: ${$('kpiDominio').textContent}`);
    $('#ringTrades').setAttribute('aria-label', `Intensidad de trades: ${$('kpiTradesDay').textContent}`);
    $('#ringVolNetx').setAttribute('aria-label', `Volumen NETX vs máximo: ${$('kpiVolNetxDay').textContent}`);
    $('#ringVolUsdt').setAttribute('aria-label', `Volumen USDT vs máximo: ${$('kpiVolUsdtDay').textContent}`);
    $('#ringGapEMA').setAttribute('aria-label', `Diferencia respecto a MA7: ${$('kpiGapEMA').textContent}`);
  }

  function movingAvg(arr, windowSize){
    const out = [];
    if (!Array.isArray(arr) || windowSize<=0) return out;
    let sum = 0, q = [];
    for (let i=0;i<arr.length;i++){
      const v = arr[i];
      if (v!=null && isFinite(v)) { sum += v; q.push(v); }
      else { q.push(null); }
      if (q.length > windowSize){
        const old = q.shift();
        if (old!=null) sum -= old;
      }
      const valid = q.filter(x=>x!=null);
      out.push(valid.length ? sum / valid.length : null);
    }
    return out;
  }

  function writeRing(id, percent, color){
    const el = $(id);
    if (!el) return;
    el.style.setProperty('--p', (isFinite(percent)? Math.max(0, Math.min(100, percent)) : 0));
    el.style.setProperty('--clr', color || 'var(--cyan)');
  }
  function writeText(id, text){ const el=$(id); if(el) el.textContent = text; }
  function clampPct(x){ return Math.max(0, Math.min(100, x)); }

  // --- FONDO DE PARTÍCULAS Y LÍNEAS (canvas) ---
  (function quantumBackground(){
    const canvas = $('bgfx');
    const ctx = canvas.getContext('2d');
    let dpr = Math.max(1, window.devicePixelRatio || 1);
    let W=0,H=0, nodes=[];
    const N = 72;                // número de nodos
    const MAX_V = .15;           // velocidad base
    const LINK_DIST = 140;       // distancia de conexión
    const MOUSE_PULL = 0.08;     // atracción al puntero
    let mouse = {x:null, y:null};

    function rand(a,b){ return a + Math.random()*(b-a); }

    function resize(){
      W = canvas.width = Math.floor(innerWidth * dpr);
      H = canvas.height = Math.floor(innerHeight * dpr);
      canvas.style.width = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
      // reescala nodos si no existen
      if (!nodes.length){
        for (let i=0;i<N;i++){
          nodes.push({
            x: rand(0,W), y: rand(0,H),
            vx: rand(-MAX_V, MAX_V)*dpr, vy: rand(-MAX_V, MAX_V)*dpr,
            r: rand(1.2, 2.2)*dpr
          });
        }
      }
    }
    resize();
    window.addEventListener('resize', resize);
    window.addEventListener('mousemove', e=>{
      const rect = canvas.getBoundingClientRect();
      mouse.x = (e.clientX - rect.left) * dpr;
      mouse.y = (e.clientY - rect.top) * dpr;
    });
    window.addEventListener('mouseleave', ()=>{ mouse.x = mouse.y = null; });

    function step(){
      ctx.clearRect(0,0,W,H);
      ctx.globalCompositeOperation = 'lighter';

      // líneas
      for(let i=0;i<nodes.length;i++){
        const a = nodes[i];
        for(let j=i+1;j<nodes.length;j++){
          const b = nodes[j];
          const dx = a.x-b.x, dy = a.y-b.y;
          const d2 = dx*dx+dy*dy;
          if (d2 < LINK_DIST*LINK_DIST*dpr*dpr){
            const d = Math.sqrt(d2);
            const alpha = 1 - (d / (LINK_DIST*dpr));
            ctx.lineWidth = 1 * dpr * alpha;
            const g = ctx.createLinearGradient(a.x,a.y,b.x,b.y);
            g.addColorStop(0, `rgba(0,224,255,${0.18*alpha})`);
            g.addColorStop(1, `rgba(42,211,155,${0.18*alpha})`);
            ctx.strokeStyle = g;
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        }
      }

      // nodos
      for(const p of nodes){
        // interacción con el puntero
        if (mouse.x!=null){
          const dx = mouse.x - p.x, dy = mouse.y - p.y;
          const d = Math.hypot(dx,dy) || 1;
          p.vx += (dx/d) * MOUSE_PULL * dpr * 0.02;
          p.vy += (dy/d) * MOUSE_PULL * dpr * 0.02;
        }
        p.x += p.vx; p.y += p.vy;

        // rebote en bordes
        if (p.x < 0 || p.x > W) p.vx *= -1, p.x = Math.max(0, Math.min(W, p.x));
        if (p.y < 0 || p.y > H) p.vy *= -1, p.y = Math.max(0, Math.min(H, p.y));

        // fricción leve
        p.vx *= 0.995; p.vy *= 0.995;

        // render del punto
        const rad = p.r;
        const grad = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rad*4);
        grad.addColorStop(0, 'rgba(255,255,255,0.65)');
        grad.addColorStop(1, 'rgba(0,224,255,0.0)');
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(p.x,p.y,rad*2,0,Math.PI*2); ctx.fill();
      }

      ctx.globalCompositeOperation = 'source-over';
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  })();

  // --- INICIALIZACIÓN ---
  function init() {
    $('txtFilterAll').oninput = applyFilter;
    $('btnRefresh').onclick = () => { currentPage = 1; loadTSV(TSV_URL); };
    if (TSV_URL) loadTSV(TSV_URL);
    enableSort('tblEx');
  }

  window.addEventListener('load', init);
</script>

<!-- Banner de promoción inferior -->
<div class="promo-banner">
  <a href="https://t.me/netx_es" target="_blank" rel="noopener noreferrer" title="Únete a la comunidad de NETX en Telegram">
    <span class="promo-text">Únete a nuestra comunidad en TELEGRAM: NETX SPANISH - https://t.me/netx_es</span>
  </a>
</div>

</body>
</html>
