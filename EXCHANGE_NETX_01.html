<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NETX • Quantum Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg0:#0c1220;--bg1:#131b2f;--panel:rgba(22,30,52,.85);--ink:#dfe7ff;--mut:#8ea0d3;--green:#2ad39b;--red:#ff5777;--cyan:#00e0ff}
  html,body{height:100%}
  body{margin:0;color:var(--ink);background:
    radial-gradient(1200px 600px at 90% -10%,rgba(94,208,255,.10),transparent 60%),
    radial-gradient(1000px 500px at -20% 0%,rgba(42,211,155,.08),transparent 60%),
    linear-gradient(180deg,var(--bg0),var(--bg1));font-family:Oxanium,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1250px;margin:22px auto;padding:0 14px}
  .card{background:var(--panel);border:1px solid #1b2440;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.03);backdrop-filter:saturate(120%) blur(6px)}
  .title{display:flex;gap:10px;align-items:center;margin:0 0 12px}
  .title .dot{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,#1f2a4a,#304170)}
  .title h1{font-size:26px;margin:0}
  .pill{border:1px solid #2b3a66;color:#9fb3ff;background:rgba(30,45,86,.6);padding:6px 10px;border-radius:999px;font-size:12px}
  .row{display:grid;gap:16px}
  .row.kpis{grid-template-columns:repeat(6,1fr)}
  .kpi h3{margin:0 0 6px;color:#9fb3ff;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .kpi .v{font-size:28px;font-weight:700}
  .v.green{color:var(--green)}.v.red{color:var(--red)}.v.cyan{color:var(--cyan)}
  .grid-2{display:grid;grid-template-columns:2.1fr 1fr;gap:16px}
  canvas{background:#0c1326;border-radius:12px;border:1px solid #1a2444}
  table{width:100%;border-collapse:collapse;color:#cfe3ff;font-size:13px}
  thead th{position:sticky;top:0;background:#0f1730;border-bottom:1px solid #2a3a66;padding:10px 8px;text-align:left;cursor:pointer;user-select:none}
  tbody td{border-bottom:1px solid #172045;padding:8px 8px}
  tbody tr:hover{background:#0e1632}
  .loading{animation:pulse 1.5s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .note{color:#9fb3ff;font-size:12px;margin-top:8px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  @media (max-width:1100px){.row.kpis{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:1fr}}
  @media (max-width:640px){.row.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" aria-live="polite">
    <div class="title">
      <div class="dot"></div>
      <h1>NETX • Quantum Dashboard</h1>
      <span id="badge" class="pill loading" title="Estado de carga">Cargando…</span>
    </div>
    <div id="msg" class="note" role="status"></div>
  </div>

  <div class="row kpis" aria-label="Indicadores clave">
    <div class="card kpi"><h3>PRECIO $NETX</h3><div id="kpiPrecio" class="v">—</div></div>
    <div class="card kpi"><h3>TRADES TOTALES</h3><div id="kpiTrades" class="v">—</div></div>
    <div class="card kpi"><h3>$NETX COMPRADOS</h3><div id="kpiComprados" class="v green">—</div></div>
    <div class="card kpi"><h3>$NETX VENDIDOS</h3><div id="kpiVendidos" class="v red">—</div></div>
    <div class="card kpi"><h3>VOL. $NETX (total)</h3><div id="kpiVolNetx" class="v cyan">—</div></div>
    <div class="card kpi"><h3>VOL. USDT (total)</h3><div id="kpiVolUsdt" class="v">—</div></div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="title"><div class="dot"></div><h1 style="font-size:18px">Serie temporal</h1></div>
      <canvas id="chart" aria-label="Serie temporal de precio y volumen" role="img"></canvas>
    </div>
    <div class="card">
      <div class="title"><div class="dot"></div><h1 style="font-size:18px">Detalle por exchange (última fila)</h1></div>
      <table id="tblEx" aria-describedby="lblFecha">
        <thead><tr><th>Exchange</th><th>Trades</th><th>Vendidos</th><th>Comprados</th><th>Vol. $NETX</th><th>Vol. USDT</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="lblFecha" class="pill" style="display:inline-block;margin-top:10px">—</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="flex title"><div class="dot"></div><h1 style="font-size:18px">Histórico (resúmenes diarios)</h1><div class="spacer"></div><input id="txtFilterAll" placeholder="Filtrar…" style="max-width:220px"/></div>
    <div style="max-height:560px;overflow:auto;border:1px solid #172045;border-radius:12px">
      <table id="tblAll" aria-label="Tabla histórica"><thead></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
  // Configuración: URL fija del TSV publicado
  const TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGjCTThPQ3rbhgN9WDwDvmDSwCpq-ue9AZTFZNF4AJa7dvmtds1D46tgAr3727jSGJcxgNCOVACFjk/pub?output=tsv";

  // Utilidades de formato
  const fmt  = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
  const fmt2 = new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
  const $ = id => document.getElementById(id);

  let DATA=null, CHART=null, EXCHANGES=[];

  const DISPLAY_NAME = { mexc:'MEXC', gate:'Gate.io', binance:'Binance', okx:'OKX', bybit:'Bybit' };

  function toNum(x){ if(x==null||x==='')return null; const s=x.toString().trim().replace(/\./g,'').replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:null; }

  // Parseador TSV
  function parseTSV(tsv){
    const lines = tsv.replace(/\r\n?/g,'\n').trim().split('\n');
    if(!lines.length) return {headers:[], data:[]};
    const headers = lines[0].split('\t').map(h=>h.trim());
    const data=[];
    for(let i=1;i<lines.length;i++){
      if(!lines[i].trim()) continue;
      const values = lines[i].split('\t');
      const row={}; headers.forEach((h,idx)=>row[h]=values[idx]??'');
      data.push(row);
    }
    return {headers, data};
  }

  // Sinónimos para encabezados canónicos
  const SYNONYMS = {
    precio:['precio','price','px'],
    trades_total:['trades_total','trades','tx_total'],
    comprados_total:['comprados_total','bought_total','buy_total'],
    vendidos_total:['vendidos_total','sold_total','sell_total'],
    vol_netx_total:['vol_netx_total','volume_netx_total','vol_total'],
    vol_usdt_total:['vol_usdt_total','volume_usdt_total'],
    fecha_ref:['fecha_ref','fecha','date','day']
  };
  function resolveHeader(headers,key){
    const list=SYNONYMS[key]||[key];
    for(const name of list){
      const f=headers.find(h=>h.toLowerCase()===name.toLowerCase());
      if(f) return f;
    }
    return null;
  }

  // Detecta exchanges por patrón
  function detectExchanges(headers){
    const set=new Set();
    headers.forEach(h=>{
      const m=h.match(/^(.*)_(trades|vendidos|comprados|vol_netx|vol_usdt)$/i);
      if(m && !m[1].toLowerCase().includes('total')) set.add(m[1].toLowerCase());
    });
    return Array.from(set).sort();
  }

  // Carga TSV
  async function loadTSV(url){
    setStatus('Cargando…', true);
    try{
      const res=await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const tsv=await res.text();
      DATA=parseTSV(tsv);
      EXCHANGES=detectExchanges(DATA.headers);
      setStatus(`✓ ${DATA.data.length} registros · ${EXCHANGES.length} exchanges detectados`);
      renderAll();
    }catch(err){
      console.error(err);
      setStatus('Error de carga', false, err.message);
    }
  }

  function setStatus(text,loading=false,detail=''){
    $('badge').textContent=text;
    $('badge').classList.toggle('loading', !!loading);
    $('badge').title=detail||'';
    $('msg').textContent=detail||'';
  }

  // Suma de columna (acumulado de todos los días)
  function sumByHeader(H, rows, headerName){
    if(!headerName) return null;
    const i=H.indexOf(headerName);
    if(i<0) return null;
    let s=0, found=false;
    for(const r of rows){
      const n=toNum(r[i]);
      if(n!=null){ s+=n; found=true; }
    }
    return found ? s : null;
  }

  // Render principal
  function renderAll(){
    if(!DATA||!DATA.data.length) return;
    const H=DATA.headers;
    const rows=DATA.data.map(o=>H.map(h=>o[h]));
    const last=rows[rows.length-1]||[];

    // Headers canónicos
    const H_px   = resolveHeader(H,'precio');
    const H_tt   = resolveHeader(H,'trades_total');
    const H_bt   = resolveHeader(H,'comprados_total');
    const H_st   = resolveHeader(H,'vendidos_total');
    const H_vnt  = resolveHeader(H,'vol_netx_total');
    const H_vut  = resolveHeader(H,'vol_usdt_total');
    const H_date = resolveHeader(H,'fecha_ref');

    const idx = h => H.indexOf(h);

    // KPI precio (última fila)
    const precio = toNum(last[idx(H_px)]);

    // KPI acumulados solicitados (sumatoria de todos los días)
    const tradesSum    = sumByHeader(H, rows, H_tt);
    const compradosSum = sumByHeader(H, rows, H_bt);
    const vendidosSum  = sumByHeader(H, rows, H_st);

    // Volúmenes (última fila)
    const volNetx = toNum(last[idx(H_vnt)]);
    const volUsdt = toNum(last[idx(H_vut)]);
    const fecha   = last[idx(H_date)] || '—';

    $('kpiPrecio').textContent    = precio   != null ? '$' + fmt2.format(precio) : '—';
    $('kpiTrades').textContent    = tradesSum!= null ? fmt.format(tradesSum)      : '—';
    $('kpiComprados').textContent = compradosSum!=null? fmt.format(compradosSum)  : '—';
    $('kpiVendidos').textContent  = vendidosSum!= null? fmt.format(vendidosSum)   : '—';
    $('kpiVolNetx').textContent   = volNetx  != null ? fmt.format(volNetx)        : '—';
    $('kpiVolUsdt').textContent   = volUsdt  != null ? fmt.format(volUsdt)        : '—';

    // Tabla por exchange (última fila)
    const exT=$('tblEx').querySelector('tbody');
    exT.innerHTML='';
    for(const pfx of EXCHANGES){
      const r=document.createElement('tr');
      const nm=DISPLAY_NAME[pfx]||pfx.toUpperCase();
      const v=(suf)=>{const h=`${pfx}_${suf}`;const id=H.indexOf(h);return id>=0?toNum(last[id])||0:0;};
      r.innerHTML = `<td>${nm}</td>
        <td>${fmt.format(v('trades'))}</td>
        <td>${fmt.format(v('vendidos'))}</td>
        <td>${fmt.format(v('comprados'))}</td>
        <td>${fmt.format(v('vol_netx'))}</td>
        <td>${fmt.format(v('vol_usdt'))}</td>`;
      exT.appendChild(r);
    }

    // Fecha
    $('lblFecha').textContent='Último registro: '+fecha;

    // Gráfico
    const priceData = rows.map(r=>toNum(r[idx(H_px)]));
    const volData   = rows.map(r=>toNum(r[idx(H_vnt)]));
    const labels    = rows.map(r=>r[idx(H_date)]||'');
    if(CHART) CHART.destroy();
    CHART = new Chart($('chart').getContext('2d'), {
      type:'line',
      data:{
        labels,
        datasets:[
          { label:'Precio $NETX', data:priceData, yAxisID:'y',
            borderColor:'#00e0ff', backgroundColor:'rgba(0,224,255,0.1)',
            tension:0.25, borderWidth:2, pointRadius:0 },
          { label:'Vol. $NETX (total)', data:volData, yAxisID:'y1', type:'bar',
            backgroundColor:'rgba(42,211,155,0.6)', borderColor:'#2ad39b', borderWidth:0 }
        ]
      },
      options:{
        responsive:true, animation:false,
        interaction:{mode:'index',intersect:false},
        scales:{
          y:{position:'left', grid:{color:'#1b2a4a'}, ticks:{color:'#9fb3ff'}},
          y1:{position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#9fb3ff'}},
          x:{grid:{color:'#1b2a4a'}, ticks:{color:'#9fb3ff'}}
        },
        plugins:{legend:{labels:{color:'#cfe3ff'}}, tooltip:{backgroundColor:'rgba(13,27,48,0.9)', titleColor:'#cfe3ff', bodyColor:'#9fb3ff', borderColor:'#2b3a66', borderWidth:1}}
      }
    });

    // Tabla histórica
    const tHead=$('tblAll').querySelector('thead');
    const tBody=$('tblAll').querySelector('tbody');
    tHead.innerHTML='<tr>'+H.map((h,i)=>`<th data-index="${i}">${h}</th>`).join('')+'</tr>';
    tBody.innerHTML = rows.map(r => '<tr>'+r.map(c=>`<td>${c==null?'':c}</td>`).join('')+'</tr>').join('');

    // Ordenación
    enableSort('tblEx');
    enableSort('tblAll', true);
  }

  // Ordenación por encabezado
  function enableSort(tableId, big=false){
    const table=$(tableId);
    const ths=table.querySelectorAll('thead th');
    ths.forEach((th,colIndex)=>{
      th.onclick=()=>{
        const tbody=table.querySelector('tbody');
        const rows=Array.from(tbody.querySelectorAll('tr'));
        const cur=th.getAttribute('data-order')||'desc';
        const next=cur==='asc'?'desc':'asc';
        ths.forEach(x=>x.removeAttribute('data-order'));
        th.setAttribute('data-order',next);
        const idx=big?parseInt(th.getAttribute('data-index')):colIndex;
        rows.sort((a,b)=>{
          const ta=a.children[idx]?.textContent?.trim()||'';
          const tb=b.children[idx]?.textContent?.trim()||'';
          const na=toNum(ta), nb=toNum(tb);
          let cmp=0;
          if(na!=null && nb!=null){ cmp=na-nb; }
          else { cmp=ta.localeCompare(tb,'es',{numeric:true,sensitivity:'base'}); }
          return next==='asc'?cmp:-cmp;
        });
        rows.forEach(r=>tbody.appendChild(r));
      };
    });
  }

  // Filtro rápido de la tabla histórica
  function applyFilter(){
    const q=$('txtFilterAll').value.toLowerCase();
    const rows=$('tblAll').querySelectorAll('tbody tr');
    rows.forEach(tr=>{
      const hit=tr.textContent.toLowerCase().includes(q);
      tr.style.display=hit?'':'none';
    });
  }
  $('txtFilterAll').oninput=applyFilter;

  // Carga inicial (sin barra de controles)
  window.addEventListener('load', ()=>{ if(TSV_URL) loadTSV(TSV_URL); });
</script>
</body>
</html>




